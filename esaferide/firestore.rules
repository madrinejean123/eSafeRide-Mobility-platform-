rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // admins can do anything if they have custom claim 'admin' == true
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Prevent unverified drivers from accepting rides directly.
    match /rides/{rideId} {
      allow read: if true;

      allow create: if request.auth != null; // basic authenticated creation

      allow update: if isAdmin() // admins can update rides
        || (
          // drivers may update rides only to mark rejection (add rejectedDrivers)
          // or accept their own ride if they are verified drivers
          request.auth != null &&
          (
            // allow driver to accept ride only if they are the authenticated user AND verified
            (request.resource.data.driverId == request.auth.uid &&
             get(/databases/$(database)/documents/drivers/$(request.auth.uid)).data.verified == true)
            ||
            // allow marking rejectedDrivers array entries by the same driver
            (request.resource.data.rejectedDrivers is list && request.auth.uid in request.resource.data.rejectedDrivers)
          )
        );
    }

    // Drivers collection: only the driver (owner) may create/update their own doc;
    // admins may read/write as necessary.
    match /drivers/{driverId} {
      allow read: if isAdmin() || request.auth != null;
      allow create: if request.auth != null && request.auth.uid == driverId;
      allow update: if isAdmin() || (request.auth != null && request.auth.uid == driverId);
      allow delete: if isAdmin();
    }

    // Admin audit: readable by admins only
    match /admin_audit/{doc} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // Fallback: allow reads, but writes require auth
    match /{document=**} {
      allow read: if true;
      allow write: if request.auth != null && isAdmin();
    }
  }
}
